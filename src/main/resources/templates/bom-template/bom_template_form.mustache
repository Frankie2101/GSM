<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Template - Garment Simple MES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="d-flex" id="wrapper">
    {{> layout/sidebar}}
    <div id="page-content-wrapper">
        {{> layout/header}}
        <main class="container-fluid p-4">
            {{#successMessage}}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{successMessage}}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {{/successMessage}}
            {{#errorMessage}}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{errorMessage}}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {{/errorMessage}}

            {{#template}}
                <div class="mb-2 d-flex align-items-center">
                    <h1 class="h5 mb-0 text-gradient-custom">
                        {{#bomTemplateId}}Edit BOM Template{{/bomTemplateId}}
                        {{^bomTemplateId}}Create New BOM Template{{/bomTemplateId}}
                    </h1>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <a href="/bom-templates" class="btn btn-link-custom"><i class="bi bi-arrow-left me-1"></i>Back</a>
                    <div>
                        <button type="submit" form="bomTemplateForm" class="btn btn-custom-gradient rounded-pill px-4 py-2">Save</button>
                    </div>
                </div>

                {{! ... header part ... }}
                <form action="/bom-templates/save" method="post" id="bomTemplateForm">
                    {{#_csrf}}
                        <input type="hidden" name="{{parameterName}}" value="{{token}}"/>
                    {{/_csrf}}
                    <input type="hidden" name="bomTemplateId" value="{{#bomTemplateId}}{{.}}{{/bomTemplateId}}">

                    <div class="card mb-4">
                        <div class="card-header text-gradient-custom"><i class="bi bi-info-circle me-1"></i>Template Information</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="bomTemplateCode" class="form-label">Template Code <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="bomTemplateCode" name="bomTemplateCode" value="{{#bomTemplateCode}}{{.}}{{/bomTemplateCode}}" required>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="bomTemplateName" class="form-label">Template Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="bomTemplateName" name="bomTemplateName" value="{{#bomTemplateName}}{{.}}{{/bomTemplateName}}" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="productCategoryId" class="form-label">Product Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="productCategoryId" name="productCategoryId" required>
                                        <option value="">-- Select a Category --</option>
                                        {{#categories}}
                                            <option value="{{id}}" {{#selected}}selected{{/selected}}>{{name}}</option>
                                        {{/categories}}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    {{!
                      BOM Details section with a dynamic table.
                      The table body is managed by bom-template-form.js.
                    }}
                    <div class="card mb-4">
                        <div class="card-header text-gradient-custom"><i class="bi bi-list-ul me-1"></i> BOM Details</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%;" class="text-center align-middle">
                                            <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                                        </th>
                                        <th style="width: 5%;">Seq</th>
                                        <th style="width: 10%;">RM Type</th>
                                        <th style="width: 17%;">Material Group</th>
                                        <th style="width: 15%;">RM Code</th>
                                        <th style="width: 20%;">RM Name</th>
                                        <th style="width: 10%;">Unit</th>
                                        <th style="width: 10%;">Usage</th>
                                        <th style="width: 8%;">Waste %</th>
                                        <th style="width: 5%;" class="text-center">Action</th>
                                    </tr>
                                    </thead>
                                    <tbody id="detailTableBody">
                                    {{!
                                       This block loops through existing details (on edit mode).
                                       The inputs use 'data-name' attributes, which JavaScript will
                                       use to generate the final 'name' attribute (e.g., "details[0].rmType").
                                     }}
                                    {{#details}}
                                        <tr>
                                            <td class="text-center align-middle">
                                                <input class="form-check-input row-checkbox" type="checkbox">
                                            </td>
                                            <td class="align-middle text-center seq-number"></td>
                                            <input type="hidden" data-name="bomTemplateDetailId" value="{{#bomTemplateDetailId}}{{.}}{{/bomTemplateDetailId}}">
                                            <input type="hidden" data-name="seq">
                                            <td>
                                                <select class="form-select rm-type-select" data-name="rmType">
                                                    <option value="">-- Select --</option>
                                                    <option value="FA" {{#isFa}}selected{{/isFa}}>Fabric</option>
                                                    <option value="TR" {{#isTr}}selected{{/isTr}}>Trim</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select class="form-select material-group-select" data-name="materialGroupId" data-selected-id="{{materialGroupId}}"></select>
                                            </td>
                                            <td>
                                                <select class="form-select rm-code-select" data-name="rmId" data-selected-id="{{#rmId}}{{.}}{{/rmId}}"></select>
                                            </td>
                                            <td><input type="text" class="form-control rm-name-input" value="{{#rmName}}{{.}}{{/rmName}}" readonly></td>
                                            <td><input type="text" class="form-control rm-unit-input" value="{{#unitName}}{{.}}{{/unitName}}" readonly></td>
                                            <td><input type="number" step="0.001" class="form-control" data-name="usageValue" value="{{#usageValue}}{{.}}{{/usageValue}}" required></td>
                                            <td><input type="number" step="0.01" class="form-control" data-name="waste" value="{{#waste}}{{.}}{{/waste}}" required></td>
                                            <td class="text-center align-middle">
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    {{/details}}
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-3">
                                <button type="button" id="addDetailBtn" class="btn btn-custom-gradient rounded-pill px-3 py-2 me-2"><i class="bi bi-plus-circle me-1"></i> New Detail</button>
                                <button type="button" id="deleteSelectedBtn" class="btn btn-delete-gradient rounded-pill px-3 py-2"><i class="bi bi-trash me-1"></i> Delete</button>
                            </div>
                        </div>
                    </div>
                </form>
            {{/template}}
        </main>
        {{> layout/footer}}
    </div>
</div>
{{> layout/scripts}}

<template id="material-groups-data-template">
    <option value="">-- Select Group --</option>
    {{#materialGroups}}
        <option value="{{materialGroupId}}">{{materialGroupName}}</option>
    {{/materialGroups}}
</template>

<script src="/js/bom-template-form.js"></script>
</body>
</html>
